# 전투 AI 시스템 - LangGraph 기반 처리 흐름

전투 시 몬스터는 상황을 인식하고 AI를 통해 다음 행동을 결정합니다. 이 과정은 LangGraph를 활용하여 **단계별 처리 흐름을 분리**하고, 각 단계에서의 판단 결과를 LLM과 규칙 기반 로직으로 결합해 **전략성과 다양성 있는 행동을 생성**합니다.

---

### 처리 단계 요약

1. **상황 분석**

   * 현재 캐릭터의 상태, 위치, 자원(AP, MOV), 상태 이상, 지형, 날씨, 전체 전투 상황 등을 기반으로 분석
   * 상태에 따라 위험 수준, 거리, 타겟 후보 등을 계산하여 상태에 포함
   * `BattleState`를 LangGraph 전용 상태로 변환

2. **전략 결정 (LLM 호출 1)**

   * 캐릭터의 성격(`traits`), 현재 상황 정보, 전투 흐름 요약(battle summary)을 기반으로 행동 전략 결정
   * 전략 유형 예: 공격 우선, 도망 우선, 지원 우선 등
   * 결과는 상태 내 `strategy` 필드에 저장

3. **행동 계획 수립 (LLM 호출 2)**

   * 전략에 따른 실제 행동 후보 생성: 이동할 위치, 사용할 스킬, 목표 타겟 등
   * 자원 정보(AP, MOV), 스킬 조건 등을 고려하여 현실 가능한 행동 제안
   * 결과는 `action_plan`에 저장

4. **대사 생성 (LLM 호출 3)**

   * 캐릭터의 성격, 전략, 행동 내용 등을 바탕으로 전투 중 발화할 대사 생성
   * 생성된 대사는 `dialogue` 필드에 저장되고, 최종적으로 `action_plan`에 포함됨

5. **응답 생성**

   * `action_plan`의 내용(이동 위치, 스킬, 타겟, 잔여 자원, 대사 등)을 API 응답 포맷(`CharacterAction`)으로 변환하여 반환

---

### 분기 처리 도입 지점

* **위험도/상황 분석에 따른 전략 분기**

  * 예: 체력이 낮으면 회피 전략 노드로 분기, 체력이 높으면 돌격 전략 노드로 분기
* **전략 유형에 따른 행동 흐름 분기**

  * 예: 도망 전략 시 타겟 없이 바로 행동 생성, 공격 전략 시 타겟 선정 포함
* **자원 조건에 따른 분기**

  * 예: AP 부족 시 행동 제한, 상태 이상 시 회복 노드로 전환

---

### 활용 효과

* 행동 생성 과정을 단계별로 분리하여 디버깅, 테스트, 개선이 용이
* 전략과 성격을 조합한 AI 행동으로 전투의 몰입도 향상
* 조건 기반 분기 처리로 다양한 전투 시나리오 대응 가능

---

### LangGraph 도입에 따른 시스템 구조 개선 정리

#### 결정 흐름 구조화

* 전투 판단 흐름을 노드 단위로 구성
* 각 판단 단계별로 독립 실행 및 오류 대응 가능
* 판단 실패 시 해당 노드만 Fallback 처리 가능

#### 조건 분기 처리 유연화

* 거리 조건, 상태 이상, 자원 부족 등을 기준으로 분기
* 몬스터 성향에 따라 다른 전략/행동 노드로 유도
* 각 노드별 분기 흐름 시각화 가능

#### 유지보수 및 확장성 강화

* 전략/행동/대사 판단 로직을 모듈화하여 재사용 가능
* 캐릭터 유형별 또는 몬스터 종별 전용 전략 노드 구성 가능
* 테스트 시 특정 노드 단독 실행 및 결과 추적 가능

#### 추론 흐름의 투명성 확보

* 상태 값, 전략, 행동 결과 등 모든 판단 로그 저장 가능
* 행동 이유와 대사를 함께 기록하여 해석 가능
* 전투 흐름 재생, 분석, 피드백 도구로 활용 가능

---

### 기대 효과

* 전략 분기 및 캐릭터 성향 기반 AI 구현
* 몰입도 높은 반응형 전투 시스템 구현
* 유지보수 비용 최소화
* LLM을 기반으로 한 전략형 전투 AI 시스템으로 확장 가능
