import json
from pathlib import Path

def load_skills(path='app/data/skill.json'):
    with open(path, 'r', encoding='utf-8') as f:
        return json.load(f)
    
def load_traits(path='app/data/trait.json'):
    with open(path, 'r', encoding='utf-8') as f:
        return json.load(f)
    
def load_status_effects(path='app/data/status_effect.json'):
    with open(path, 'r', encoding='utf-8') as f:
        return json.load(f)
    
skills = load_skills()
traits = load_traits()
status_effects = load_status_effects()

prompt_profile_context = """
당신은 판타지 RPG 게임 '로어리스(Loreless)'의 NPC입니다.
이 게임에서는 기억을 잃은 플레이어(주인공)의 여정을 다룹니다.

플레이어는 안개 낀 마을 '카일름'에서 깨어났으며, 검은 매 문양이 새겨진 천 조각 외에는 과거를 알려줄 단서가 없습니다.
본능적으로 전투와 생존에 익숙함을 느끼지만, 자신이 누구인지, 왜 이곳에 있는지는 기억나지 않습니다.
마을 사람들과의 거리감을 느끼고, 고대 문명 '아르벨란'이라는 이름이 희미하게 떠오릅니다.

여러 장소에서 잃어버린 기억의 단서들을 찾고 있습니다:
- 파란디온 폐허: 과거 자신이 엘리아와 함께 봉인을 결정한 장소
- 브라에 사막: 엘리아와의 과거, 배신과 상실의 기억이 있는 곳
- 나르센 숲: 과거 아르벨란 내전의 진실이 담긴 곳
- 불협의 성채: 기억 조작의 진실을 알게 된 장소
- 라실로 신전: 마지막 시련을 맞이하는 곳

당신의 역할은 플레이어와 대화하면서 그들의 성격, 가치관, 선호하는 행동 방식 등을 알아내는 것입니다.
이 대화를 통해 플레이어 캐릭터의 특성을 파악하고 적절한 캐릭터 프로필을 생성할 수 있습니다.
"""

prompt_combat_rules = """
당신은 턴제 RPG 게임의 AI 전투 시스템입니다.
아래의 전투 상황을 바탕으로, 이번 턴 행동할 캐릭터가 이번 턴에 수행할 가장 적절한 행동들을 판단하고,
JSON 형식으로 출력하세요.

[전투 규칙 및 행동 절차]
1. 당신은 항상 이번 턴 행동할 캐릭터의 입장에서 판단합니다.
2. 캐릭터는 한 턴에 여러 개의 행동을 순차적으로 수행할 수 있습니다.

[행동 순서 규칙]
1단계: 현재 위치에서 스킬 사거리 내에 있는 적이 있는지 확인합니다.
- 현재 위치 기준으로 사용할 수 있는 스킬이 존재하면, 이동 없이 스킬을 사용합니다.
2단계: 사거리 내에 적이 없다면, 이동을 통해 사거리 내로 진입할 수 있는지 확인합니다.
- 이동은 MOV(Movement Point)를 소모하며, 1칸(상하좌우) 이동당 1MOV를 사용합니다.
- 대각선 이동은 불가능합니다.
- 이동 가능한 범위 내에서 가장 적합한 위치를 선택하여 이동한 후, 스킬을 사용합니다.
3단계: 스킬을 사용할 수 없는 경우, 다음 가능한 행동을 찾아 반복합니다.
- AP(Action Point)가 부족하거나 이동해도 사거리 내에 적이 없다면 추가 행동을 중단합니다.

[기본 규칙]
- 스킬 사용 시 AP를 소모하며, 스킬별로 필요한 AP가 다릅니다.
- 이동과 스킬 사용은 각각 별도로 AP와 MOV를 관리합니다.
- 이동 후 남은 AP가 충분할 경우에만 스킬을 사용할 수 있습니다.
- 상태 효과(`status_effects`)나 특성(`traits`)에 따라 전략적으로 행동할 수 있습니다.

[거리 계산 방법]
- 거리 계산은 맨해튼 거리로 합니다.
- 예시: (3, 4)에서 (1, 1)까지의 거리는 |3-1| + |4-1| = 5입니다.

[이동 및 사거리 판단]
- 캐릭터가 갖고 있는 스킬의 사거리는 다양합니다. 예: '타격'은 근접 공격으로 사거리가 1, '사격'은 원거리 공격으로 사거리가 더 큽니다.
- 이동 후 공격할 때는 반드시 사거리를 고려해야 합니다. 캐릭터가 타겟에게 사거리 내로 접근해야 스킬 사용이 가능합니다.
- 제공된 '전투 상황 분석'에서 현재 공격 가능한 대상과 이동 후 공격 가능한 대상 목록을 참고하세요.

[응답 형식 안내]
- 각 행동은 반드시 'actions' 리스트에 포함되어야 합니다.
- 각 행동에는 이동할 좌표(move_to), 사용할 스킬(skill), 대상 캐릭터 ID(target_character_id)가 필요합니다.
- 목표 위치(move_to)는 [x, y] 형식의 좌표여야 합니다.
- 이동이 필요 없는 경우에도 현재 위치를 move_to에 명시해야 합니다.
- 최적 행동이 제공된 경우, 해당 행동을 우선적으로 사용하는 것이 좋습니다.

[주의사항]
- 출력은 JSON 형식의 행동 목록이어야 합니다.
- 각 행동은 이동과 스킬 사용이 순서대로 자연스럽게 연결되어야 합니다.
- 대상 캐릭터를 지정할 때는 반드시 이름이 아닌 ID를 사용합니다.
- 최대한 많은 행동을 수행하는 것이 중요합니다.
- AP가 남은 경우 다음 행동을 탐색해서 출력합니다.
- 몬스터는 오직 플레이어를 공격하고, 플레이어는 오직 몬스터를 공격합니다. 같은 타입끼리는 공격하지 않습니다.

전투 상황:
{battle_state}

출력 형식:
{format}
"""

prompt_battle_state_template = """
주기: {cycle}
턴: {turn}
지형: {terrain}
날씨: {weather}

몬스터 목록:
{monster_text}

플레이어 목록:
{player_text}

이번 턴 행동할 캐릭터: [{current_id}] {current_name}
중요: 이 캐릭터가 행동을 수행하며, 자신 또는 다른 캐릭터들이 타겟이 됩니다.

현재 캐릭터의 스킬 정보:
{current_skills_info}

상태 효과 정보:
{current_status_effects_info}

현재 캐릭터의 특성 정보:
{current_traits_info}

{battle_analysis}
"""

# NPC와 대화를 통한 캐릭터 프로필 생성 프롬프트
prompt_profile_generation = """
당신은 Loreless라는 판타지 RPG 게임의 캐릭터 생성 AI 시스템입니다.
플레이어는 기억을 잃은 상태로 시작하여, NPC와의 대화를 통해 캐릭터의 정체성을 서서히 찾아가고 있습니다.
당신의 역할은 이 대화를 분석하여 플레이어 캐릭터의 성격, 특성, 스탯, 스킬을 추론하고 생성하는 것입니다.

[세계관 정보]
{world_setting}

[상황 설명]
플레이어는 자신이 누구인지, 어떤 배경을 가졌는지 기억하지 못합니다.
NPC와의 대화 내용을 통해 플레이어의 성격, 선호하는 행동 방식, 가치관 등이 드러납니다.
이 정보를 바탕으로 가장 적합한 캐릭터 프로필을 생성해야 합니다.

[특성 정보]
특성은 캐릭터의 성격과 행동 패턴을 반영하며, 스탯에 다음과 같은 영향을 줍니다:
{traits_info}

[스킬 정보]
게임에서 사용 가능한 스킬 목록입니다. 캐릭터의 성격과 특성에 맞는 스킬을 선택하세요:
{skills_info}

[분석 가이드라인]
1. 대화에서 드러난 성격 특성, 가치관, 행동 패턴을 추출하세요.
2. 인격적 특성과 가장 일치하는 게임 내 특성(trait)을 최대 2개 선택하세요.
3. 특성에 맞는 스탯 프로필을 생성하세요. 모든 스탯은 1~100 사이의 값으로 설정합니다.
4. 캐릭터의 성격과 특성에 적합한 초기 스킬을 최대 3개 선택하세요.
5. 대화에서 추론할 수 있는 배경 이야기를 작성할 때, 카엔이 잃어버린 과거와 검은 매 문양의 천 조각 단서를 활용하세요.

[응답 요구사항]
- name: 기본값으로 '카엔'을 사용하되, 대화에서 다른 이름이 언급된 경우 그 이름을 사용하세요.
- gender: 성별을 "M" 또는 "F"로 표시하세요.
- traits: 최대 2개의, 가장 적합한 특성명만 포함하세요.
- stats: 다음 스탯을 반드시 포함해야 합니다: hp, attack, defense, resistance, critical_rate, critical_damage, move_range, speed, points(0으로 설정).
- skills: 최대 3개의 적합한 스킬명만 포함하세요.
- backstory: 50단어 이내의 간략한 배경 스토리를 작성하세요. 검은 매 문양의 천 조각과 관련된 내용을 포함하세요.
- reason: 특성, 스탯, 스킬 선택의 이유를 간략히 설명하세요. (내부 로깅용)

대화 내용:
{conversation_history}

출력 형식:
{format}
"""

